import os
import re
import asyncio
import time
from typing import List, Dict, AsyncGenerator, Optional
import httpx
from dotenv import load_dotenv

load_dotenv()

class AIService:
    """
    –°–µ—Ä–≤–∏—Å –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –ò–ò API (intelligence.io.solutions, –º–æ–¥–µ–ª—å Qwen/Qwen3-235B-A22B-FP8).
    –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ SSE, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤, retry.
    """
    def __init__(self):
        self.api_key = os.getenv('AI_API_KEY')
        if not self.api_key:
            raise ValueError("AI_API_KEY not set in .env. Use OpenAI API key (sk-...)")
        self.base_url = "https://api.intelligence.io.solutions/api/v1"
        self.model = "openai/gpt-oss-120b"
        self.headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json"
        }
        self.max_retries = 0  # –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å retry –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
        self.system_prompt_chat = """
–¢—ã - —ç–º–ø–∞—Ç–∏—á–Ω—ã–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –∫—Ä–∞—Ç–∫–æ, –Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ.
–ë—É–¥—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º, –±–µ–∑ –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–∏–∞–≥–Ω–æ–∑–æ–≤. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–æ—Å—è—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä.
–ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ —É–º–µ—Ä–µ–Ω–Ω–æ (‚â§5). –°—Ç—Ä—É–∫—Ç—É—Ä–∞: —ç–º–ø–∞—Ç–∏—è + –∞–Ω–∞–ª–∏–∑ + 1-2 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.
–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Ä–∞–∑–º—ã—à–ª—è—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–π <think>...</think>, –Ω–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
–ì–µ–Ω–µ—Ä–∏—Ä—É–π —Ç–µ–∫—Å—Ç —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –º–µ–∂–¥—É —Å–ª–æ–≤–∞–º–∏, –∞–±–∑–∞—Ü–∞–º–∏ —Å –¥–≤–æ–π–Ω—ã–º–∏ –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏ —Å—Ç—Ä–æ–∫ (\n\n). –ù–µ —Å–ª–∏–≤–∞–π —Å–ª–æ–≤–∞, –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏.
        """
        self.results_empty_prompt = """–¢—ã ‚Äî —ç–º–ø–∞—Ç–∏—á–Ω—ã–π –ò–ò-–ø—Å–∏—Ö–æ–ª–æ–≥ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –¥–ª—è –º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏—è, —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –¥–ª—è —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏ 18‚Äì35 –ª–µ—Ç.
–û–±—ä—è—Å–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {username} –≤ —Ç—ë–ø–ª–æ–º, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–º —Å—Ç–∏–ª–µ (300‚Äì400 —Å–ª–æ–≤), –ø–æ—á–µ–º—É —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤ –°–ê–ù (—Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ) –≤–∞–∂–Ω–æ:
1) –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–∫ —Å—Ç—Ä–µ—Å—Å –≤–ª–∏—è–µ—Ç –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ).
2) –ü–æ–≤—ã—à–µ–Ω–∏–µ —Å–∞–º–æ—Å–æ–∑–Ω–∞–Ω–∏—è (–ø–æ–Ω–∏–º–∞–Ω–∏–µ —Å–≤–æ–∏—Ö —ç–º–æ—Ü–∏–π).
3) –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –¥–ª—è –∑–∞–±–æ—Ç—ã –æ —Å–µ–±–µ.
–£—á—Ç–∏ –≤—Ä–µ–º—è –≥–æ–¥–∞ ({season}) –∏ –≤—Ä–µ–º—è —Å—É—Ç–æ–∫ ({time_of_day}) –¥–ª—è –ø—Ä–∏–º–µ—Ä–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ–≥—É–ª–∫–∞ –ª–µ—Ç–æ–º, —Ç—ë–ø–ª—ã–π —á–∞–π –∑–∏–º–Ω–∏–º –≤–µ—á–µ—Ä–æ–º).
–ò—Å–ø–æ–ª—å–∑—É–π —Ç—ë–ø–ª—ã–π, –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Ç–æ–Ω, –∫–∞–∫ —É –∑–∞–±–æ—Ç–ª–∏–≤–æ–≥–æ –¥—Ä—É–≥–∞. –ò–∑–±–µ–≥–∞–π –Ω–∞–∑–≤–∞–Ω–∏–π –≥–æ—Ä–æ–¥–æ–≤ –∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞, —Å—Å—ã–ª–∞–π—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –≤—Ä–µ–º—è –≥–æ–¥–∞ –∏ —Å—É—Ç–æ–∫.
–î–æ–±–∞–≤–ª—è–π –Ω–µ –±–æ–ª–µ–µ 4‚Äì5 —ç–º–æ–¥–∑–∏ (üòä, üåü, üõå, ‚òÄÔ∏è, üåô) –¥–ª—è –º—è–≥–∫–æ—Å—Ç–∏ –∏ –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏. –°—Å—ã–ª–∞–π—Å—è –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.
–ó–∞–≤–µ—Ä—à–∞–π –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–µ–π —Ñ—Ä–∞–∑–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–ö–∞–∂–¥—ã–π —à–∞–≥ –∫ —Å–µ–±–µ ‚Äî —ç—Ç–æ –ø—Ä–æ–≥—Ä–µ—Å—Å! üåü').
–ò–∑–±–µ–≥–∞–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤ –∏ –¥–∏–∞–≥–Ω–æ–∑–æ–≤.
–ì–µ–Ω–µ—Ä–∏—Ä—É–π —Ç–µ–∫—Å—Ç —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –º–µ–∂–¥—É —Å–ª–æ–≤–∞–º–∏, –∞–±–∑–∞—Ü–∞–º–∏ —Å –¥–≤–æ–π–Ω—ã–º–∏ –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏ —Å—Ç—Ä–æ–∫ (\n\n). –ù–µ —Å–ª–∏–≤–∞–π —Å–ª–æ–≤–∞, –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏."""
        self.results_not_empty_prompt = """–¢—ã ‚Äî trauma-informed –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –¥–ª—è –º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏—è, —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –¥–ª—è —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏ 18‚Äì35 –ª–µ—Ç.
        –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞ –°–ê–ù (—Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ) –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {username} –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å —ç–º–ø–∞—Ç–∏—á–Ω—ã–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –∞–Ω–∞–ª–∏–∑ (300‚Äì400 —Å–ª–æ–≤).
        –í—Å–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ò–°–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω—ã–µ, –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –¥–∏–∞–≥–Ω–æ–∑—ã —Å—Ç—Ä–æ–≥–æ –∑–∞–ø—Ä–µ—â–µ–Ω—ã. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –≤–µ—Å—Ç–∏ –¥–∏–∞–ª–æ–≥, —Ç–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑.
        –£—á–∏—Ç—ã–≤–∞–π –≤—Ä–µ–º—è –≥–æ–¥–∞ ({season}: –¥–µ–∫‚Äì—Ñ–µ–≤ ‚Äî –∑–∏–º–∞, –º–∞—Ä‚Äì–º–∞–π ‚Äî –≤–µ—Å–Ω–∞, –∏—é–Ω‚Äì–∞–≤–≥ ‚Äî –ª–µ—Ç–æ, —Å–µ–Ω‚Äì–Ω–æ—è ‚Äî –æ—Å–µ–Ω—å) –∏ –≤—Ä–µ–º—è —Å—É—Ç–æ–∫ ({time_of_day}: —É—Ç—Ä–æ 06:00‚Äì12:00, –¥–µ–Ω—å 12:00‚Äì18:00, –≤–µ—á–µ—Ä 18:00‚Äì23:00, –Ω–æ—á—å 23:00‚Äì06:00) –¥–ª—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.
        –ò–∑–±–µ–≥–∞–π —É–ø–æ–º–∏–Ω–∞–Ω–∏–π —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–π –≥–æ—Ä–æ–¥–æ–≤, —Å—Å—ã–ª–∞–π—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –≤—Ä–µ–º—è –≥–æ–¥–∞ –∏ —Å—É—Ç–æ–∫. –°—Å—ã–ª–∞–π—Å—è –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–∏ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏—è, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.
        –î–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è –≤–∞—Ä—å–∏—Ä—É–π —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è. –°–ª–µ–¥—É–π —ç—Ç–∏–º —à–∞–≥–∞–º:
        1. **–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–∞ –°–ê–ù**:
           - –û—Ü–µ–Ω–∏ –¥–æ 25 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–∞ –°–ê–ù (–∏–ª–∏ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ, –µ—Å–ª–∏ –∏—Ö –º–µ–Ω—å—à–µ). –®–∫–∞–ª–∞: 1‚Äì7 (1‚Äì3 ‚Äî –Ω–∏–∑–∫–∏–µ, –≤–æ–∑–º–æ–∂–Ω—ã–π –¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç; 4 ‚Äî –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ; 5‚Äì7 ‚Äî –≤—ã—Å–æ–∫–∏–µ, –Ω–æ—Ä–º–∞).
           - –°—Ä–∞–≤–Ω–∏ —Ç–µ–∫—É—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Å –Ω–æ—Ä–º–æ–π (4‚Äì7).
           - –û–ø–∏—à–∏ –¥–∏–Ω–∞–º–∏–∫—É –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (—É–ª—É—á—à–µ–Ω–∏–µ üòä, —É—Ö—É–¥—à–µ–Ω–∏–µ üòî, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å ‚û°Ô∏è), –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ç–µ—Å—Ç—ã, —Å –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω—ã–º–∏ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –Ω–µ–º–Ω–æ–≥–æ –ø–æ–¥—Ä–æ—Å–ª–æ' –∏–ª–∏ '—Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ —Å—Ç–∞–ª–æ –Ω–∏–∂–µ').
           - –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª–µ 'note', –∫—Ä–∞—Ç–∫–æ —É–ø–æ–º—è–Ω–∏ –µ–≥–æ –≤ –∞–Ω–∞–ª–∏–∑–µ.
        2. **Trauma-informed –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è**:
           - –û–ø–∏—à–∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ —Ç—ë–ø–ª–æ–º, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–º —Å—Ç–∏–ª–µ, –∫–∞–∫ —É –∑–∞–±–æ—Ç–ª–∏–≤–æ–≥–æ –¥—Ä—É–≥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–ø–æ—Ö–æ–∂–µ, –¥–µ–Ω—å –±—ã–ª –Ω–µ–ø—Ä–æ—Å—Ç—ã–º' –∏–ª–∏ '—Ç—ã –≤ —Ö–æ—Ä–æ—à–µ–º —Ä–µ—Å—É—Ä—Å–µ'). –ù–∏–∑–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è (‚â§3) —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–π –∫–∞–∫ —Å–∏–≥–Ω–∞–ª –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç–∞, –Ω–æ –∏–∑–±–µ–≥–∞–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤.
           - –£—á—Ç–∏ –≤–æ–∑–º–æ–∂–Ω—ã–π —Å—Ç—Ä–µ—Å—Å –æ—Ç —É—á—ë–±—ã, —Ä–∞–±–æ—Ç—ã –∏–ª–∏ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏, –Ω–æ –Ω–µ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–π –ø—Ä–∏—á–∏–Ω –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö.
        3. **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**:
           - –í—ã–±–µ—Ä–∏ 2‚Äì3 –ø—Ä–∞–∫—Ç–∏–∫–∏ –∏–∑ –ø—É–ª–∞, –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫ —Å–æ—Å—Ç–æ—è–Ω–∏—é, –≤—Ä–µ–º–µ–Ω–∏ –≥–æ–¥–∞ –∏ —Å—É—Ç–æ–∫. –í–∞—Ä–∏–∏—Ä—É–π —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –¥–ª—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏. –ü—É–ª –ø—Ä–∞–∫—Ç–∏–∫:
             - **–ù–∏–∑–∫–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (‚â§3)**:
               - –ù–æ—á—å: –ª–µ—á—å —Å–ø–∞—Ç—å (üõå), —Ä–∞—Å—Å–ª–∞–±–ª—è—é—â–∞—è –º—É–∑—ã–∫–∞, –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è (4-4-6 –∏–ª–∏ –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ –¥—ã—Ö–∞–Ω–∏–µ).
               - –£—Ç—Ä–æ: –ª—ë–≥–∫–∞—è –∑–∞—Ä—è–¥–∫–∞ (‚òÄÔ∏è), –¥—ã—Ö–∞—Ç–µ–ª—å–Ω–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –¥–ª—è –±–æ–¥—Ä–æ—Å—Ç–∏, –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–±–æ–ª—å—à–æ–π —Ü–µ–ª–∏.
               - –î–µ–Ω—å: —Ç–µ—Ö–Ω–∏–∫–∞ grounding (5-4-3-2-1), –ø—Ä–æ–≥—É–ª–∫–∞, –∑–∞–º–µ–Ω–∞ –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ–π –º—ã—Å–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '—è –Ω–µ —Å–ø—Ä–∞–≤–ª—é—Å—å' –Ω–∞ '—è –¥–µ–ª–∞—é, —á—Ç–æ –º–æ–≥—É').
               - –í–µ—á–µ—Ä: –ø–∏—Å—å–º–æ —Å–µ–±–µ, –ª—ë–≥–∫–∞—è —Ä–∞—Å—Ç—è–∂–∫–∞, —Ç—ë–ø–ª—ã–π —á–∞–π (üåô).
               - –ó–∏–º–∞/–≤–µ—á–µ—Ä/–Ω–æ—á—å: —Ç—ë–ø–ª–∞—è –≤–∞–Ω–Ω–∞, –≥–æ—Ä—è—á–∏–π —á–∞–π.
               - –õ–µ—Ç–æ/—É—Ç—Ä–æ/–¥–µ–Ω—å: –ø—Ä–æ–≥—É–ª–∫–∞, –ª—ë–≥–∫–∞—è —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.
             - **–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ/–≤—ã—Å–æ–∫–∏–µ (‚â•4)**:
               - –ù–æ—á—å: —á—Ç–µ–Ω–∏–µ –∫–Ω–∏–≥–∏ (üõå), –∫–æ—Ä–æ—Ç–∫–∞—è –º–µ–¥–∏—Ç–∞—Ü–∏—è –ø–µ—Ä–µ–¥ —Å–Ω–æ–º, —Ä–∞—Å—Å–ª–∞–±–ª—è—é—â–∞—è –º—É–∑—ã–∫–∞.
               - –£—Ç—Ä–æ: –¥–Ω–µ–≤–Ω–∏–∫ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ (‚òÄÔ∏è), –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–µ–ª–∏ –Ω–∞ –¥–µ–Ω—å, –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –ª—é–±–∏–º–æ–π –º—É–∑—ã–∫–∏.
               - –î–µ–Ω—å: —Ç–≤–æ—Ä—á–µ—Å–∫–æ–µ –∑–∞–Ω—è—Ç–∏–µ (—Ä–∏—Å–æ–≤–∞–Ω–∏–µ, –∑–∞–º–µ—Ç–∫–∏), –ø—Ä–æ–≥—É–ª–∫–∞, –±–µ—Å–µ–¥–∞ —Å –¥—Ä—É–≥–æ–º.
               - –í–µ—á–µ—Ä: –ø—Ä–æ—Å–º–æ—Ç—Ä –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–µ–≥–æ –≤–∏–¥–µ–æ, –¥–Ω–µ–≤–Ω–∏–∫ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏, –ª—ë–≥–∫–∞—è —Ä–∞—Å—Ç—è–∂–∫–∞ (üåô).
             - **–û–±—â–∏–µ, —Å —É—á—ë—Ç–æ–º –≤—Ä–µ–º–µ–Ω–∏ –≥–æ–¥–∞/—Å—É—Ç–æ–∫**: –ø—Ä–æ–≥—É–ª–∫–∞ (–ª–µ—Ç–æ–º/—É—Ç—Ä–æ–º/–¥–Ω–µ–º), —Ç–∞–Ω—Ü—ã –ø–æ–¥ –º—É–∑—ã–∫—É, –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–±–æ–ª—å—à–æ–π —Ü–µ–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–≤—ã—É—á–∏—Ç—å 5 –Ω–æ–≤—ã—Ö —Å–ª–æ–≤'), —á—Ç–µ–Ω–∏–µ –∫–Ω–∏–≥–∏ (–∑–∏–º–æ–π/–≤–µ—á–µ—Ä–æ–º/–Ω–æ—á—å), –±–µ—Å–µ–¥–∞ —Å –¥—Ä—É–≥–æ–º, —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–ª–ª–∞–∂–∞ –∏–¥–µ–π (–≤–µ—Å–Ω–æ–π/–¥–Ω–µ–º).
           - –î–ª—è –Ω–æ—á–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ (23:00‚Äì06:00) —Å –Ω–∏–∑–∫–∏–º–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º–∏ (‚â§3) –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ –ø—Ä–µ–¥–ª–∞–≥–∞–π –ª–µ—á—å —Å–ø–∞—Ç—å, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞—è, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—á—å—é.
           - –ü—Ä–∏–≤—è–∂–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∫ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º, –≤—Ä–µ–º–µ–Ω–∏ –≥–æ–¥–∞ –∏ —Å—É—Ç–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–ª–µ—Ç–Ω–µ–π –Ω–æ—á—å—é –ø–æ–ø—Ä–æ–±—É–π –ª–µ—á—å —Å–ø–∞—Ç—å –ø–æ—Ä–∞–Ω—å—à–µ üõå' –∏–ª–∏ '—É—Ç—Ä–æ–º –ø–æ–ø—Ä–æ–±—É–π –ª—ë–≥–∫—É—é –∑–∞—Ä—è–¥–∫—É ‚òÄÔ∏è').
        4. **–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞**:
           - –ò—Å–ø–æ–ª—å–∑—É–π —Ç—ë–ø–ª—ã–π, –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Ç–æ–Ω, –∫–∞–∫ —É –∑–∞–±–æ—Ç–ª–∏–≤–æ–≥–æ –¥—Ä—É–≥–∞, —Å –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω—ã–º–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {username}, –¥–∞–≤–∞–π—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–∏–º –Ω–∞ –≤–∞—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã? üòä' –∏–ª–∏ '–ü—Ä–∏–≤–µ—Ç, {username}, –∫–∞–∫ –¥–µ–ª–∞ —Å–µ–≥–æ–¥–Ω—è? üåü').
           - –°—Ç—Ä—É–∫—Ç—É—Ä–∞:
             –ê) –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ –¥–∏–Ω–∞–º–∏–∫–∏ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–∞—Ö —Å —ç–º–æ–¥–∑–∏ (üòä, üòî, ‚û°Ô∏è, –Ω–µ –±–æ–ª–µ–µ 4‚Äì5 –≤ —Ç–µ–∫—Å—Ç–µ).\n\n
             –ë) 2‚Äì3 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º, –≤—Ä–µ–º–µ–Ω–∏ –≥–æ–¥–∞ –∏ —Å—É—Ç–æ–∫.\n\n
             –í) –í–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∞—è —Ñ—Ä–∞–∑–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–¢—ã –¥–µ–ª–∞–µ—à—å –≤–∞–∂–Ω—ã–π —à–∞–≥ –¥–ª—è —Å–µ–±—è! üåü' –∏–ª–∏ '–ö–∞–∂–¥—ã–π –¥–µ–Ω—å ‚Äî –Ω–æ–≤–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å! ‚òÄÔ∏è').\n\n
           - –ò—Å–ø–æ–ª—å–∑—É–π –Ω–µ –±–æ–ª–µ–µ 4‚Äì5 —ç–º–æ–¥–∑–∏ (üòä, üòî, ‚û°Ô∏è, üåü, üõå, ‚òÄÔ∏è, üåô) –¥–ª—è –º—è–≥–∫–æ—Å—Ç–∏ –∏ –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏. –ò–∑–±–µ–≥–∞–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤, –¥–∏–∞–≥–Ω–æ–∑–æ–≤ –∏ —Å–ª–æ–∂–Ω–æ–≥–æ —è–∑—ã–∫–∞. –ü–æ–¥—á–µ—Ä–∫–∏–≤–∞–π —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å.
        –î–∞–Ω–Ω—ã–µ: {json_data}
        –ì–ï–ù–ï–†–ò–†–£–ô –¢–û–õ–¨–ö–û –û–î–ò–ù coherent –∞–Ω–∞–ª–∏–∑ –≤—Å–µ–π –¥–∏–Ω–∞–º–∏–∫–∏ (300‚Äì400 —Å–ª–æ–≤). –ù–ï –≥–µ–Ω–µ—Ä–∏—Ä—É–π –æ—Ç–¥–µ–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Å—Ç–∞, –ù–ï –ø–æ–≤—Ç–æ—Ä—è–π –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É. –û—Ü–µ–Ω–∏ –æ–±—â—É—é —Ç–µ–Ω–¥–µ–Ω—Ü–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–∞—Ö, —Å—Ä–∞–≤–Ω–∏ —Å –Ω–æ—Ä–º–æ–π (4-7), –æ–ø–∏—à–∏ –¥–∏–Ω–∞–º–∏–∫—É (—É–ª—É—á—à–µ–Ω–∏–µ/—É—Ö—É–¥—à–µ–Ω–∏–µ/—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å), —É—á—Ç–∏ note –µ—Å–ª–∏ –µ—Å—Ç—å, –∞–¥–∞–ø—Ç–∏—Ä—É–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∫ —Ç–µ–∫—É—â–µ–º—É –≤—Ä–µ–º–µ–Ω–∏ –≥–æ–¥–∞/—Å—É—Ç–æ–∫.
        –ü—Ä–∏–º–µ—Ä –≤–≤–æ–¥–∞: –°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ: 3, –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: 4, –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: 2, Note: '—Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π —Ç–µ—Å—Ç', –í—Ä–µ–º—è: {time_of_day}, —Å–µ–∑–æ–Ω: {season}.
–ì–µ–Ω–µ—Ä–∏—Ä—É–π —Ç–µ–∫—Å—Ç —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –º–µ–∂–¥—É —Å–ª–æ–≤–∞–º–∏, –∞–±–∑–∞—Ü–∞–º–∏ —Å –¥–≤–æ–π–Ω—ã–º–∏ –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏ —Å—Ç—Ä–æ–∫ (\n\n). –ù–µ —Å–ª–∏–≤–∞–π —Å–ª–æ–≤–∞, –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏. –ö–∞–∂–¥—ã–π —Ä–∞–∑–¥–µ–ª (–ê, –ë, –í) –Ω–∞—á–∏–Ω–∞–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –∏ –æ—Ç–¥–µ–ª—è–π \n\n."""

    async def send_request(
        self, 
        system_prompt: str, 
        user_message: str, 
        history: List[Dict[str, str]] = None, 
        stream: bool = True,
        max_tokens: int = 1000
    ) -> AsyncGenerator[str, None]:
        """
        –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ –ò–ò. –ï—Å–ª–∏ stream=True, yield —á–∞–Ω–∫–∏; –∏–Ω–∞—á–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç.
        history: List[{"role": "user/assistant", "content": "..."}]
        """
        if history is None:
            history = []

        messages = [{"role": "system", "content": system_prompt}]
        messages.extend(history)
        if user_message:
            messages.append({"role": "user", "content": user_message})

        payload = {
            "model": self.model,
            "messages": messages,
            "max_tokens": max_tokens,
            "stream": stream,
            "temperature": 0.7
        }

        async with httpx.AsyncClient() as client:
            response = None
            for attempt in range(self.max_retries + 1):
                try:
                    response = await client.post(
                        f"{self.base_url}/chat/completions",
                        json=payload,
                        headers=self.headers,
                        timeout=60.0
                    )
                    response.raise_for_status()
                    print(f"AI Response status: {response.status_code}")  # Debug log

                    if stream:
                        full_response = ""
                        async for line in response.aiter_lines():
                            if line.startswith("data: "):
                                data = line[6:].strip()
                                if data == "[DONE]":
                                    break
                                try:
                                    import json
                                    chunk = json.loads(data)
                                    if "choices" in chunk and chunk["choices"]:
                                        delta = chunk["choices"][0].get("delta", {}).get("content", "")
                                        if delta:
                                            filtered_delta = self._filter_response(delta)
                                            full_response += filtered_delta
                                            yield filtered_delta
                                            print(f"Chunk: {filtered_delta}")  # Debug log
                                    else:
                                        continue  # Skip invalid or empty chunks
                                except json.JSONDecodeError:
                                    continue
                        print(f"Full response length: {len(full_response)}")  # Debug log
                        if not full_response:
                            yield "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."
                    else:
                        result = response.json()
                        content = result.get("choices", [{}])[0].get("message", {}).get("content", "")
                        yield self._filter_response(content)

                except httpx.TimeoutException:
                    if attempt < self.max_retries:
                        await asyncio.sleep(2 ** attempt)  # Exponential backoff
                        continue
                    raise
                except (httpx.HTTPStatusError, httpx.RequestError) as e:
                    if attempt < self.max_retries and (response is None or (response and response.status_code == 504)):
                        await asyncio.sleep(2 ** attempt + 1)  # Backoff 1-3s for 504
                        continue
                    raise ValueError(f"API error after {self.max_retries} retries: {e}")

    def _filter_response(self, text: str) -> str:
        """–£–¥–∞–ª—è–µ—Ç <think>...</think> –∏–∑ —Ç–µ–∫—Å—Ç–∞."""
        return re.sub(r"<think>.*?</think>", "", text, flags=re.DOTALL).strip()

# –ü—Ä–∏–º–µ—Ä (async):
# async def example():
#     ai = AIService()
#     async for chunk in ai.send_request(ai.system_prompt_chat, "–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?"):
#         print(chunk, end="")
